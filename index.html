<meta name='viewport' content='width=device-width, initial-scale=1'/><!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Offline Story Reader</title>
    <meta name="theme-color" content="#667eea">
    <link rel="manifest" href="data:application/json;base64,ewogICJuYW1lIjogIk9mZmxpbmUgU3RvcnkgUmVhZGVyIiwKICAic2hvcnRfbmFtZSI6ICJTdG9yeVJlYWRlciIsCiAgImRlc2NyaXB0aW9uIjogIkRvd25sb2FkIGFuZCByZWFkIHN0b3JpZXMgb2ZmbGluZSIsCiAgInN0YXJ0X3VybCI6ICIvIiwKICAiZGlzcGxheSI6ICJzdGFuZGFsb25lIiwKICAiYmFja2dyb3VuZF9jb2xvciI6ICIjNjY3ZWVhIiwKICAidGhlbWVfY29sb3IiOiAiIzY2N2VlYSIsCiAgImljb25zIjogWwogICAgewogICAgICAic3JjIjogImRhdGE6aW1hZ2Uvc3ZnK3htbDtiYXNlNjQsUEhOMlp5QjNhV1IwYUQwaU1qUXdJaUJvWldsbmFIUTlJakkwTUNJZ2RtbGxkMEp2ZUQwaU1DQXdJREkwTUNBeU5EQWlJSGh0Ykc1elBTSm9kSFJ3T2k4dmQzZDNMbmN6TG05eVp5OHlNREF3TDNOMlp5SStQR05wY21Oc1pTQmplRDBpTVRJd0lpQmplVDBpTVRJd0lpQnlQU0kxTUNJZ1ptbHNiRDBpSXpZMk4yVmxZU0l2UGp4d1lYUm9JR1E5SW0wNU1DQTJNR013TFRFMkxqUXNNVE11TmpWTU5qTXNOelpoTVRZc01UWXNNVFlzTVRaYU9UQXNOakJhSWk5K1BIQmhkR2dnWkQwaWJUWXdJRGd3YURFeU1IWTBNRUkxTUN3ME9FZ3lNREYyUmpSQkxUVXdMVFE0V2lJZ1ptbHNiRDBpWXlOallTSTBOV0ZtWWlJdlBqd3ZjM1puUGc9PSIsCiAgICAgICJzaXplcyI6ICIyNDB4MjQwIiwKICAgICAgInR5cGUiOiAiaW1hZ2Uvc3ZnK3htbCIKICAgIH0KICBdCn0=">;
    <link rel="apple-touch-icon" href="data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMjQwIiBoZWlnaHQ9IjI0MCIgdmlld0JveD0iMCAwIDI0MCAyNDAiIHhtbG5zPSJodHRwOi8vd3d3LnczLm9yZy8yMDAwL3N2ZyI+PGNpcmNsZSBjeD0iMTIwIiBjeT0iMTIwIiByPSI1MCIgZmlsbD0iIzY2N2VlYSIvPjxwYXRoIGQ9Im05MCA2MGMwLTE2LjQsMTMuNjUtMzAsNDAtMzBIOTBaIi8+PHBhdGggZD0ibTYwIDgwaDEyMHY0MGE1MCw0OEgyMDF2RjRBLTUwLTQ4WiIgZmlsbD0iI2NhNDVhZmIiLz48L3N2Zz4=">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            color: #333;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }

        .header {
            text-align: center;
            color: white;
            margin-bottom: 30px;
        }

        .header h1 {
            font-size: 2.5rem;
            margin-bottom: 10px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
        }

        .card {
            background: white;
            border-radius: 15px;
            padding: 30px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
            margin-bottom: 20px;
            backdrop-filter: blur(10px);
        }

        .tab-container {
            display: flex;
            background: #f8f9fa;
            border-radius: 10px;
            padding: 5px;
            margin-bottom: 20px;
        }

        .tab {
            flex: 1;
            padding: 12px 20px;
            background: transparent;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s ease;
        }

        .tab.active {
            background: #667eea;
            color: white;
            box-shadow: 0 2px 10px rgba(102, 126, 234, 0.3);
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #555;
        }

        .form-group input, .form-group textarea {
            width: 100%;
            padding: 12px;
            border: 2px solid #e1e5e9;
            border-radius: 8px;
            font-size: 16px;
            transition: border-color 0.3s ease;
        }

        .form-group input:focus, .form-group textarea:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        .btn {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            margin-right: 10px;
            margin-bottom: 10px;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
        }

        .btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }

        .btn-secondary {
            background: #6c757d;
        }

        .btn-danger {
            background: #dc3545;
        }

        .progress-bar {
            width: 100%;
            height: 8px;
            background: #e1e5e9;
            border-radius: 4px;
            overflow: hidden;
            margin: 20px 0;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #667eea, #764ba2);
            width: 0%;
            transition: width 0.3s ease;
        }

        .story-list {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }

        .story-card {
            background: #f8f9fa;
            border-radius: 10px;
            padding: 20px;
            border-left: 4px solid #667eea;
            transition: transform 0.3s ease;
        }

        .story-card:hover {
            transform: translateY(-3px);
            box-shadow: 0 5px 20px rgba(0,0,0,0.1);
        }

        .story-title {
            font-size: 1.2rem;
            font-weight: 600;
            margin-bottom: 10px;
            color: #333;
        }

        .story-meta {
            color: #666;
            font-size: 0.9rem;
            margin-bottom: 15px;
        }

        .reading-progress {
            background: #e1e5e9;
            height: 4px;
            border-radius: 2px;
            overflow: hidden;
            margin-bottom: 15px;
        }

        .reading-progress-fill {
            height: 100%;
            background: #28a745;
            transition: width 0.3s ease;
        }

        .reader-container {
            max-width: 800px;
            margin: 0 auto;
            background: white;
            border-radius: 15px;
            padding: 40px;
            line-height: 1.8;
            font-size: 18px;
        }

        .reader-controls {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 30px;
            padding: 20px;
            background: #f8f9fa;
            border-radius: 10px;
        }

        .font-controls {
            display: flex;
            gap: 10px;
            align-items: center;
        }

        .status-indicator {
            display: inline-block;
            width: 12px;
            height: 12px;
            border-radius: 50%;
            margin-right: 8px;
        }

        .status-online {
            background: #28a745;
        }

        .status-offline {
            background: #dc3545;
        }

        .status-syncing {
            background: #ffc107;
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        .hidden {
            display: none;
        }

        .alert {
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
        }

        .alert-success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }

        .alert-error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }

        .alert-info {
            background: #cce7ff;
            color: #004085;
            border: 1px solid #b3d7ff;
        }

        @media (max-width: 768px) {
            .container {
                padding: 10px;
            }
            
            .header h1 {
                font-size: 2rem;
            }
            
            .card {
                padding: 20px;
            }
            
            .reader-container {
                padding: 20px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>📚 Offline Story Reader</h1>
            <p>Download, sync, and read your favorite stories across all devices</p>
        </div>

        <!-- Login Screen -->
        <div id="loginScreen" class="card">
            <div class="tab-container">
                <button class="tab active" onclick="switchAuthTab('login')">Login</button>
                <button class="tab" onclick="switchAuthTab('register')">Register</button>
            </div>
            
            <div id="loginTab" class="tab-content active">
                <form id="loginForm">
                    <div class="form-group">
                        <label for="loginEmail">Email</label>
                        <input type="email" id="loginEmail" required>
                    </div>
                    <div class="form-group">
                        <label for="loginPassword">Password</label>
                        <input type="password" id="loginPassword" required>
                    </div>
                    <button type="submit" class="btn">Login</button>
                </form>
            </div>
            
            <div id="registerTab" class="tab-content">
                <form id="registerForm">
                    <div class="form-group">
                        <label for="registerName">Name</label>
                        <input type="text" id="registerName" required>
                    </div>
                    <div class="form-group">
                        <label for="registerEmail">Email</label>
                        <input type="email" id="registerEmail" required>
                    </div>
                    <div class="form-group">
                        <label for="registerPassword">Password</label>
                        <input type="password" id="registerPassword" required>
                    </div>
                    <button type="submit" class="btn">Register</button>
                </form>
            </div>
        </div>

        <!-- Main App -->
        <div id="mainApp" class="hidden">
            <div class="card">
                <div class="tab-container">
                    <button class="tab active" onclick="switchMainTab('download')">Download Stories</button>
                    <button class="tab" onclick="switchMainTab('library')">My Library</button>
                    <button class="tab" onclick="switchMainTab('reader')">Reader</button>
                    <button class="tab" onclick="switchMainTab('settings')">Settings</button>
                </div>

                <!-- Download Tab -->
                <div id="downloadTab" class="tab-content active">
                    <h2>Download Stories</h2>
                    <div id="downloadAlert"></div>
                    
                    <form id="downloadForm">
                        <div class="form-group">
                            <label for="storyUrl">Story URL or Base URL</label>
                            <input type="url" id="storyUrl" placeholder="https://example.com/story/chapter-1" required>
                        </div>
                        
                        <div class="form-group">
                            <label for="storyTitle">Story Title</label>
                            <input type="text" id="storyTitle" placeholder="My Favorite Story" required>
                        </div>
                        
                        <div class="form-group">
                            <label for="pageCount">Number of Pages/Chapters</label>
                            <input type="number" id="pageCount" value="10" min="1" max="100" required>
                        </div>
                        
                        <div class="form-group">
                            <label for="urlPattern">URL Pattern (optional)</label>
                            <input type="text" id="urlPattern" placeholder="Leave empty for auto-detection">
                            <small>Use {n} for page numbers. Example: https://site.com/story/chapter-{n}</small>
                        </div>
                        
                        <button type="submit" class="btn" id="downloadBtn">Start Download</button>
                        <button type="button" class="btn btn-secondary" id="stopDownloadBtn" style="display: none;">Stop Download</button>
                    </form>
                    
                    <div id="downloadProgress" style="display: none;">
                        <h3>Download Progress</h3>
                        <div class="progress-bar">
                            <div class="progress-fill" id="progressFill"></div>
                        </div>
                        <p id="progressText">Preparing download...</p>
                    </div>
                </div>

                <!-- Library Tab -->
                <div id="libraryTab" class="tab-content">
                    <h2>My Story Library</h2>
                    <div class="story-list" id="storyList">
                        <!-- Stories will be loaded here -->
                    </div>
                </div>

                <!-- Reader Tab -->
                <div id="readerTab" class="tab-content">
                    <div id="readerControls" class="reader-controls">
                        <div>
                            <button class="btn btn-secondary" onclick="goToLibrary()">← Back to Library</button>
                            <span id="currentStoryTitle">Select a story to read</span>
                        </div>
                        <div class="font-controls">
                            <button class="btn btn-secondary" onclick="changeFontSize(-1)">A-</button>
                            <button class="btn btn-secondary" onclick="changeFontSize(1)">A+</button>
                        </div>
                    </div>
                    
                    <div class="reader-container" id="readerContent">
                        <p>Select a story from your library to start reading.</p>
                    </div>
                    
                    <div class="reader-controls">
                        <button class="btn btn-secondary" onclick="previousPage()">← Previous</button>
                        <span id="pageInfo">Page 1 of 1</span>
                        <button class="btn btn-secondary" onclick="nextPage()">Next →</button>
                    </div>
                </div>

                <!-- Settings Tab -->
                <div id="settingsTab" class="tab-content">
                    <h2>Settings</h2>
                    
                    <div class="form-group">
                        <label>
                            <span class="status-indicator" id="syncStatus"></span>
                            Sync Status
                        </label>
                        <p id="syncStatusText">Checking sync status...</p>
                        <button class="btn" onclick="forcSync()">Force Sync Now</button>
                    </div>
                    
                    <div class="form-group">
                        <label>Account</label>
                        <p>Logged in as: <span id="userEmail"></span></p>
                        <button class="btn btn-danger" onclick="logout()">Logout</button>
                    </div>
                    
                    <div class="form-group">
                        <label>Storage</label>
                        <p id="storageInfo">Calculating storage usage...</p>
                        <button class="btn btn-secondary" onclick="clearCache()">Clear Downloaded Stories</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // App State
        let currentUser = null;
        let stories = [];
        let currentStory = null;
        let currentPage = 0;
        let downloadController = null;
        let fontSize = 18;

        // Mock API for demonstration (in production, this would be real backend calls)
        const mockAPI = {
            async login(email, password) {
                // Simulate API call
                await new Promise(resolve => setTimeout(resolve, 1000));
                if (email && password) {
                    return { id: 1, email, name: email.split('@')[0] };
                }
                throw new Error('Invalid credentials');
            },
            
            async register(name, email, password) {
                await new Promise(resolve => setTimeout(resolve, 1000));
                return { id: 1, email, name };
            },
            
            async syncUserData(userId) {
                // In production, this would sync with backend
                const saved = localStorage.getItem(`user_${userId}_stories`);
                return saved ? JSON.parse(saved) : [];
            },
            
            async saveUserData(userId, data) {
                localStorage.setItem(`user_${userId}_stories`, JSON.stringify(data));
                return true;
            }
        };

        // Utility Functions
        function showAlert(message, type = 'info', containerId = 'downloadAlert') {
            const container = document.getElementById(containerId);
            if (!container) {
                // If no specific container, show in the current active tab
                const activeTab = document.querySelector('.tab-content.active');
                if (activeTab) {
                    const alertDiv = document.createElement('div');
                    alertDiv.className = `alert alert-${type}`;
                    alertDiv.textContent = message;
                    activeTab.insertBefore(alertDiv, activeTab.firstChild);
                    setTimeout(() => alertDiv.remove(), 5000);
                }
                return;
            }
            container.innerHTML = `<div class="alert alert-${type}">${message}</div>`;
            setTimeout(() => container.innerHTML = '', 5000);
        }

        function updateSyncStatus(status) {
            const indicator = document.getElementById('syncStatus');
            const text = document.getElementById('syncStatusText');
            
            if (!indicator || !text) return;
            
            indicator.className = `status-indicator status-${status}`;
            
            switch(status) {
                case 'online':
                    text.textContent = 'Synced across all devices';
                    break;
                case 'syncing':
                    text.textContent = 'Syncing with cloud...';
                    break;
                case 'offline':
                    text.textContent = 'Offline mode - will sync when online';
                    break;
            }
        }

        // Authentication Functions
        function switchAuthTab(tab) {
            document.querySelectorAll('#loginScreen .tab').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('#loginScreen .tab-content').forEach(t => t.classList.remove('active'));
            
            event.target.classList.add('active');
            document.getElementById(tab + 'Tab').classList.add('active');
        }

        function switchMainTab(tab) {
            document.querySelectorAll('#mainApp .tab').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('#mainApp .tab-content').forEach(t => t.classList.remove('active'));
            
            event.target.classList.add('active');
            document.getElementById(tab + 'Tab').classList.add('active');
        }

        async function handleLogin(e) {
            e.preventDefault();
            const email = document.getElementById('loginEmail').value;
            const password = document.getElementById('loginPassword').value;
            
            try {
                const user = await mockAPI.login(email, password);
                currentUser = user;
                
                // Load user data
                stories = await mockAPI.syncUserData(user.id);
                
                // Show main app
                document.getElementById('loginScreen').classList.add('hidden');
                document.getElementById('mainApp').classList.remove('hidden');
                
                // Update UI
                document.getElementById('userEmail').textContent = user.email;
                updateLibrary();
                updateSyncStatus('online');
                
                showAlert('Login successful!', 'success');
            } catch (error) {
                showAlert('Login failed: ' + error.message, 'error');
            }
        }

        async function handleRegister(e) {
            e.preventDefault();
            const name = document.getElementById('registerName').value;
            const email = document.getElementById('registerEmail').value;
            const password = document.getElementById('registerPassword').value;
            
            try {
                const user = await mockAPI.register(name, email, password);
                showAlert('Registration successful! Please login.', 'success');
                
                // Auto-fill login form
                document.getElementById('loginEmail').value = email;
                document.getElementById('loginPassword').value = password;
                
                // Switch to login tab
                document.querySelector('#loginScreen .tab').click();
            } catch (error) {
                showAlert('Registration failed: ' + error.message, 'error');
            }
        }

        function logout() {
            currentUser = null;
            stories = [];
            currentStory = null;
            currentPage = 0;
            
            document.getElementById('loginScreen').classList.remove('hidden');
            document.getElementById('mainApp').classList.add('hidden');
            
            // Reset forms
            document.getElementById('loginForm').reset();
            document.getElementById('registerForm').reset();
        }

        // Download Functions
        async function simulatePageDownload(url, pageNum) {
            // Simulate downloading a webpage
            await new Promise(resolve => setTimeout(resolve, 500 + Math.random() * 1000));
            
            // Generate mock content
            const content = `
                <h1>Chapter ${pageNum}</h1>
                <p>This is the beginning of chapter ${pageNum} of your story. In a real implementation, this would be the actual content scraped from the webpage at ${url}.</p>
                <p>Lorem ipsum dolor sit amet, consectetur adipiscing elit. Sed do eiusmod tempor incididunt ut labore et dolore magna aliqua. Ut enim ad minim veniam, quis nostrud exercitation ullamco laboris nisi ut aliquip ex ea commodo consequat.</p>
                <p>Duis aute irure dolor in reprehenderit in voluptate velit esse cillum dolore eu fugiat nulla pariatur. Excepteur sint occaecat cupidatat non proident, sunt in culpa qui officia deserunt mollit anim id est laborum.</p>
                <p>Sed ut perspiciatis unde omnis iste natus error sit voluptatem accusantium doloremque laudantium, totam rem aperiam, eaque ipsa quae ab illo inventore veritatis et quasi architecto beatae vitae dicta sunt explicabo.</p>
            `;
            
            return content;
        }

        async function handleDownload(e) {
            e.preventDefault();
            
            const storyUrl = document.getElementById('storyUrl').value;
            const storyTitle = document.getElementById('storyTitle').value;
            const pageCount = parseInt(document.getElementById('pageCount').value);
            const urlPattern = document.getElementById('urlPattern').value;
            
            // Create AbortController for cancellation
            downloadController = new AbortController();
            
            // Show progress
            document.getElementById('downloadProgress').style.display = 'block';
            document.getElementById('downloadBtn').style.display = 'none';
            document.getElementById('stopDownloadBtn').style.display = 'inline-block';
            
            const progressFill = document.getElementById('progressFill');
            const progressText = document.getElementById('progressText');
            
            try {
                const story = {
                    id: Date.now(),
                    title: storyTitle,
                    url: storyUrl,
                    pageCount: pageCount,
                    pages: [],
                    downloadDate: new Date().toISOString(),
                    currentPage: 0,
                    progress: 0
                };
                
                for (let i = 1; i <= pageCount; i++) {
                    if (downloadController.signal.aborted) {
                        throw new Error('Download cancelled');
                    }
                    
                    progressText.textContent = `Downloading page ${i} of ${pageCount}...`;
                    
                    let pageUrl = storyUrl;
                    if (urlPattern) {
                        pageUrl = urlPattern.replace('{n}', i);
                    } else {
                        // Simple auto-detection logic
                        pageUrl = storyUrl.replace(/\d+/, i);
                    }
                    
                    const content = await simulatePageDownload(pageUrl, i);
                    story.pages.push({
                        url: pageUrl,
                        content: content,
                        title: `Chapter ${i}`
                    });
                    
                    const progress = (i / pageCount) * 100;
                    progressFill.style.width = progress + '%';
                }
                
                // Add to stories and save
                stories.push(story);
                await mockAPI.saveUserData(currentUser.id, stories);
                
                progressText.textContent = 'Download completed!';
                showAlert(`Successfully downloaded "${storyTitle}" with ${pageCount} pages!`, 'success');
                
                updateLibrary();
                updateSyncStatus('syncing');
                setTimeout(() => updateSyncStatus('online'), 2000);
                
            } catch (error) {
                if (error.message === 'Download cancelled') {
                    progressText.textContent = 'Download cancelled';
                    showAlert('Download was cancelled', 'info');
                } else {
                    progressText.textContent = 'Download failed';
                    showAlert('Download failed: ' + error.message, 'error');
                }
            } finally {
                document.getElementById('downloadBtn').style.display = 'inline-block';
                document.getElementById('stopDownloadBtn').style.display = 'none';
                downloadController = null;
                
                setTimeout(() => {
                    document.getElementById('downloadProgress').style.display = 'none';
                    progressFill.style.width = '0%';
                }, 3000);
            }
        }

        function stopDownload() {
            if (downloadController) {
                downloadController.abort();
            }
        }

        // Library Functions
        function updateLibrary() {
            const storyList = document.getElementById('storyList');
            
            if (stories.length === 0) {
                storyList.innerHTML = '<p>No stories downloaded yet. Use the Download tab to add some stories!</p>';
                return;
            }
            
            storyList.innerHTML = stories.map(story => `
                <div class="story-card">
                    <div class="story-title">${story.title}</div>
                    <div class="story-meta">
                        ${story.pageCount} pages • Downloaded ${new Date(story.downloadDate).toLocaleDateString()}
                    </div>
                    <div class="reading-progress">
                        <div class="reading-progress-fill" style="width: ${(story.currentPage / story.pageCount) * 100}%"></div>
                    </div>
                    <p>Progress: Page ${story.currentPage + 1} of ${story.pageCount}</p>
                    <button class="btn" onclick="openStory(${story.id})">
                        ${story.currentPage > 0 ? 'Continue Reading' : 'Start Reading'}
                    </button>
                    <button class="btn btn-danger" onclick="deleteStory(${story.id})">Delete</button>
                </div>
            `).join('');
        }

        function openStory(storyId) {
            currentStory = stories.find(s => s.id === storyId);
            if (!currentStory) return;
            
            currentPage = currentStory.currentPage;
            
            // Switch to reader tab
            switchMainTab('reader');
            updateReader();
        }

        async function deleteStory(storyId) {
            if (confirm('Are you sure you want to delete this story?')) {
                stories = stories.filter(s => s.id !== storyId);
                await mockAPI.saveUserData(currentUser.id, stories);
                updateLibrary();
                showAlert('Story deleted successfully', 'info');
            }
        }

        // Reader Functions
        function updateReader() {
            if (!currentStory) return;
            
            const titleEl = document.getElementById('currentStoryTitle');
            const contentEl = document.getElementById('readerContent');
            const pageInfoEl = document.getElementById('pageInfo');
            
            titleEl.textContent = currentStory.title;
            contentEl.innerHTML = currentStory.pages[currentPage]?.content || '<p>Page not found</p>';
            contentEl.style.fontSize = fontSize + 'px';
            pageInfoEl.textContent = `Page ${currentPage + 1} of ${currentStory.pageCount}`;
            
            // Save progress
            currentStory.currentPage = currentPage;
            mockAPI.saveUserData(currentUser.id, stories);
        }

        function previousPage() {
            if (currentStory && currentPage > 0) {
                currentPage--;
                updateReader();
            }
        }

        function nextPage() {
            if (currentStory && currentPage < currentStory.pageCount - 1) {
                currentPage++;
                updateReader();
            }
        }

        function changeFontSize(delta) {
            fontSize = Math.max(12, Math.min(32, fontSize + delta));
            if (currentStory) {
                document.getElementById('readerContent').style.fontSize = fontSize + 'px';
            }
        }

        function goToLibrary() {
            switchMainTab('library');
        }

        // Settings Functions
        async function forcSync() {
            updateSyncStatus('syncing');
            showAlert('Syncing data...', 'info');
            
            // Simulate sync
            await new Promise(resolve => setTimeout(resolve, 2000));
            await mockAPI.saveUserData(currentUser.id, stories);
            
            updateSyncStatus('online');
            showAlert('Sync completed successfully!', 'success');
        }

        function clearCache() {
            if (confirm('This will delete all downloaded stories. Are you sure?')) {
                stories = [];
                currentStory = null;
                currentPage = 0;
                mockAPI.saveUserData(currentUser.id, stories);
                updateLibrary();
                showAlert('All stories cleared', 'info');
            }
        }

        function updateStorageInfo() {
            const storyCount = stories.length;
            const totalPages = stories.reduce((sum, story) => sum + story.pageCount, 0);
            const storageElement = document.getElementById('storageInfo');
            if (storageElement) {
                storageElement.textContent = `${storyCount} stories, ${totalPages} pages stored locally`;
            }
        }

        // Event Listeners
        document.getElementById('loginForm').addEventListener('submit', handleLogin);
        document.getElementById('registerForm').addEventListener('submit', handleRegister);
        document.getElementById('downloadForm').addEventListener('submit', handleDownload);
        document.getElementById('stopDownloadBtn').addEventListener('click', stopDownload);

        // Service Worker Registration for PWA
        if ('serviceWorker' in navigator) {
            navigator.serviceWorker.register('data:application/javascript;base64,Ly8gU2VydmljZSBXb3JrZXIgZm9yIG9mZmxpbmUgZnVuY3Rpb25hbGl0eQpzZWxmLmFkZEV2ZW50TGlzdGVuZXIoJ2luc3RhbGwnLCBldmVudCA9PiB7CiAgY29uc29sZS5sb2coJ1NlcnZpY2UgV29ya2VyIGluc3RhbGxlZCcpOwp9KTsKCnNlbGYuYWRkRXZlbnRMaXN0ZW5lcignZmV0Y2gnLCBldmVudCA9PiB7CiAgLy8gSW50ZXJjZXB0IG5ldHdvcmsgcmVxdWVzdHMgZm9yIG9mZmxpbmUgZnVuY3Rpb25hbGl0eQp9KTs=')
                .then(() => console.log('Service Worker registered'))
                .catch(err => console.log('Service Worker registration failed'));
        }

        // Add install prompt for PWA
        let deferredPrompt;
        window.addEventListener('beforeinstallprompt', (e) => {
            e.preventDefault();
            deferredPrompt = e;
            
            // Show install button in settings
            const installBtn = document.createElement('button');
            installBtn.className = 'btn';
            installBtn.textContent = 'Install as App';
            installBtn.onclick = async () => {
                deferredPrompt.prompt();
                const { outcome } = await deferredPrompt.userChoice;
                if (outcome === 'accepted') {
                    showAlert('App installed successfully!', 'success');
                }
                deferredPrompt = null;
                installBtn.remove();
            };
            
            const settingsTab = document.getElementById('settingsTab');
            if (settingsTab) {
                const installGroup = document.createElement('div');
                installGroup.className = 'form-group';
                installGroup.innerHTML = '<label>Install App</label><p>Install this app on your device for better offline experience.</p>';
                installGroup.appendChild(installBtn);
                settingsTab.appendChild(installGroup);
            }
        });

        // Initialize app
        function initApp() {
            updateSyncStatus('offline');
            updateStorageInfo();
            
            // Check if user is already logged in (in production, check for valid token)
            const savedUser = localStorage.getItem('currentUser');
            if (savedUser) {
                // Auto-login logic would go here
            }
        }

        // Start the app
        initApp();
    </script>
</body>
</html>